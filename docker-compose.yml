version: '3.8'

services:
  build-essentials:
    build:
      context: .
      dockerfile: Dockerfile.build-essentials
      args:
        UBUNTU_VERSION: ${UBUNTU_VERSION}
    image: mybuild/build-essentials

  download-kernel-source:
    build:
      context: .
      dockerfile: Dockerfile.download-kernel-source
      args:
        KERNEL_MAJOR_VERSION: ${KERNEL_MAJOR_VERSION}
        KERNEL_VERSION: ${KERNEL_VERSION}
    image: mybuild/download-kernel-source
    depends_on:
      - build-essentials

  compile-kernel:
    build:
      context: .
      dockerfile: Dockerfile.compile-kernel
      args:
        KERNEL_MAJOR_VERSION: ${KERNEL_MAJOR_VERSION}
        KERNEL_VERSION: ${KERNEL_VERSION}

    image: mybuild/compile-kernel
    depends_on:
      - download-kernel-source

  install-kernel:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        KERNEL_VERSION: ${KERNEL_VERSION}
    image: mybuild/install-kernel
    depends_on:
      - compile-kernel

  test:
      build:
        context: .
        dockerfile: Dockerfile.test
        args:
          KERNEL_VERSION: ${KERNEL_VERSION}
      image: mybuild/test-image      